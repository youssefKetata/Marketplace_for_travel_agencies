{% extends 'seller_side/base_seller.html.twig' %}

{% block banner %}
    <section id="common_banner">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="common_bannner_text">
                        <h2>Customer dashboard</h2>
                        <ul>
                            <li><a href="{{ path('app_seller_side_dashboard') }}">Home</a></li>
                            <li><span><i class="fas fa-circle"></i></span>Customer dashboard</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block content %}

    {% if selectedOffers is defined and app.session.has('selectedOffers') and app.session.get('selectedOffers')|length != 0 %}
        {% set totalPrice = 0 %}
        <section id="tour_details_main" class="section_padding">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="tour_details_leftside_wrapper">
                            <div class="tour_details_heading_wrapper">
                                <div class="tour_details_top_heading">
                                    <h2>Card</h2>
                                </div>
                            </div>

                            {% for message in app.flashes('error') %}
                                <div class="alert alert-light d-flex align-items-center alert-dismissible fade show border-danger" role="alert">
                                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                    <span>{{ message }}</span>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}

                            {% for message in app.flashes('success') %}
                                <div class="alert alert-light d-flex align-items-center alert-dismissible fade show border-success" role="alert">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>{{ message }}</span>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}

                            {% set nbOffer = 0 %}
                            {% for index in 0..selectedOffers|length-1 %}
                                {% set nbOffer = nbOffer + 1 %}
                                {% set offer = selectedOffers[index] %}
                                {% set form = forms[index] %}

                                {% set offerPrice = 0 %}
                                <div class="tour_details_boxed">
                                    <h3 class="heading_theme">Offer: {{ offer.name }} <p>validity: ({{ offer.nbDays }} days)</p></h3>
                                    <div class="tour_details_boxed_inner">
                                        <h4>Including products ({{ offer.nbProductTypes }})</h4><br>
                                        <ul>
                                            {% for offerProductType in  offer.offerProductTypes%}
                                                {% set offerPrice = offerPrice + offerProductType.price %}
                                                {% set totalPrice = totalPrice + offerProductType.price %}

                                                <div class="tour_details_top_heading_right">
                                                    <h5>ðŸž„ {{ offerProductType.productType.name }}</h5>
                                                </div>
                                                <p>&nbsp;&nbsp;&nbsp;Max items: {{ offerProductType.maxItems }} &nbsp;|&nbsp;   Price: {{ offerProductType.price }}</p>

                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <!--  date form -->
                                    {{ form_start(form, { 'attr': {'class': 'offer-form'} }) }}
                                    {{ form_widget(form) }}
                                    {{ form_end(form) }}
                                    <div class="edit_person">
                                        <p>Price: {{ offerPrice }}</p>
                                    </div>
                                    <a class="" href="{{ path('app_seller_side_removeFromCard',{'id': offer.id}) }}">
                                        <i class="bi bi-trash"></i>Remove item</a>

                                </div>
                            {% endfor %}


                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="tour_details_right_sidebar_wrapper">
                            <div class="tour_detail_right_sidebar">
                                <div class="tour_details_right_boxed">
                                    <div class="tour_details_right_box_heading">
                                        <h3>Details</h3>
                                    </div>
                                    <div class="tour_package_details_bar_list">

                                        <ul>
                                            <li><i class="fas fa-circle"></i>Total offers ({{ nbOffer }})</li>
                                            <li><i class="fas fa-circle"></i>Others details</li>

                                        </ul>
                                    </div>
                                    <div class="tour_package_details_bar_price">
                                        <h5>Total price</h5>
                                        <div class="tour_package_bar_price">
                                            <h6><del></del></h6>
                                            <h3>$ {{ totalPrice }} <sub></sub> </h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="tour_select_offer_bar_bottom">
                                    <button class="btn btn_theme btn_md w-100" data-bs-toggle="modal"
                                            data-bs-target="#exampleModal"
                                            id="submit-all-forms">Buy</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    {% else %}
        <div class="d-flex justify-content-center">
            <div class="tour_details_boxed col-lg-10">
                <div style="margin-left: 38%">
                    <img class=""style="" src="{{ asset('assets/images/emptyCard.png') }}">
                </div>
                <p class="top_form_search_button">You didn't choose any offer, you can pick one here</p>
                <div class="top_form_search_button">
                    <a href="{{ path('app_seller_side_offer') }}">
                        <button class="btn btn_theme btn_md">List of offers</button>
                    </a>
                </div>
            </div>
        </div>
    {% endif %}



    <!-- Buy Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body logout_modal_content">
                    <div class="btn_modal_closed">
                        <button type="button" data-bs-dismiss="modal" aria-label="Close"><i
                                    class="fas fa-times"></i></button>
                    </div>
                    <h3>
                        Buying process
                    </h3>
                    <div class="logout_approve_button">
                        <button data-bs-dismiss="modal" class="btn btn_theme btn_md" id="logout-confirm-btn">Buy</button>
                        <button data-bs-dismiss="modal" class="btn btn_border btn_md">No Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            document.getElementById('logout-confirm-btn').addEventListener('click', function (){
                let formData = {};
                let isFormValid = true; // add a variable to check if all required fields are filled out
                $('.offer-form').each(function() {
                    let formFields = $(this).serializeArray();
                    formFields.forEach(function(field) {
                        if(field.value.trim() === '') { // check if the field is empty or only contains spaces
                            isFormValid = false; // set the flag to false if any required field is empty
                        }
                        formData[field.name] = field.value;
                    });
                });
                if(isFormValid) { // only send the data if all required fields are filled out
                    $.ajax({
                        type: 'POST',
                        url: '{{ path('app_seller_side_buyOffer') }}',
                        data: formData,
                        success: function(response) {
                            console.log('Success: ' + JSON.stringify(response));
                            // redirect to the new page
                            window.location.href = response.newPageUrl;
                            document.getElementById('logout-confirm-btn').removeEventListener('click',this);
                        },
                        error: function(response) {
                            console.log('Error: ' + JSON.stringify(response));
                        }
                    });
                    isFormValid=false;
                } else {
                    console.log('date no valid')
                }
            });
        });
    </script>

    <style>
        input[type="date"] {
            width: 50%;
        }
    </style>

{% endblock %}